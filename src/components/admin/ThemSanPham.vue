<script setup>
import { ref, onMounted } from "vue";
import { useRoute } from "vue-router";

const search = ref("");
const selected = ref({});
const quantities = ref({});

const route = useRoute();
const maHoaDon = route.params.maHoaDon;

let listSanPham = ref([]);

const fetchTodos = async () => {
  try {
    const response = await fetch("http://localhost:8080/chi-tiet-san-pham");
    const json = await response.json();
    listSanPham.value = json;
  } catch (error) {
    console.error("L·ªói khi fetch d·ªØ li·ªáu:", error);
  }
};

onMounted(() => {
  fetchTodos();
});

// th√™m s·∫£n ph·∫©m v√†o cthd

const emit = defineEmits(["chonSanPham"]);
const selectedItems = ref([]);
const toggleSelection = (item) => {
  const index = selectedItems.value.findIndex(
    (i) => i.maChiTietSapPham === item.maChiTietSapPham
  );

  if (index === -1) {
    selectedItems.value.push(item);
    quantities.value[item.maChiTietSapPham] = 1;
  } else {
    selectedItems.value.splice(index, 1);
    delete quantities.value[item.maChiTietSapPham];
  }
};

const apply = async () => {
  const result = selectedItems.value.map((item) => {
    const soLuongMua = quantities.value[item.maChiTietSapPham] || 1;
    const gia = item.gia;
    return {
      idSanPhamChiTiet: item.maChiTietSapPham,
      gia: item.gia,
      soLuong: soLuongMua,
      thanhTien: gia * soLuongMua,
      idHoaDon: maHoaDon,
      trangThai: 0, // ho·∫∑c tr·∫°ng th√°i m·∫∑c ƒë·ªãnh
    };
  });

  //ki·ªÉm tra d·ªØ li·ªáu: 
   // üëâ Ki·ªÉm tra d·ªØ li·ªáu g·ªëc
  console.log("‚úÖ D·ªØ li·ªáu result g·ª≠i xu·ªëng:", result);

  const bodyUpdateSoLuong = result.map((r) => ({
    idSanPhamChiTiet: r.idSanPhamChiTiet,
    soLuongMua: r.soLuong,
  }));

  // üëâ Ki·ªÉm tra body g·ª≠i xu·ªëng API update s·ªë l∆∞·ª£ng
  console.log("üì¶ Body g·ª≠i update s·ªë l∆∞·ª£ng:", bodyUpdateSoLuong);

  // 1. C·∫≠p nh·∫≠t t·ªìn kho
  try {
    await fetch("http://localhost:8080/chi-tiet-san-pham/update-so-luong", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(bodyUpdateSoLuong),
    });
  } catch (error) {
    console.error("L·ªói khi c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng t·ªìn kho:", error);
  }

  // 2. L∆∞u chi ti·∫øt h√≥a ƒë∆°n
  try {
    await fetch("http://localhost:8080/hoa-don-chi-tiet/add", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(result),
    });
  } catch (error) {
    console.error("L·ªói khi l∆∞u h√≥a ƒë∆°n chi ti·∫øt:", error);
  }
  emit("selected", selectedItems.value);
  emit("close");
};

</script>

<template>
  <div
    class="modal fade show d-block"
    tabindex="-1"
    style="background-color: rgba(0, 0, 0, 0.5); z-index: 1050"
  >
    <div class="modal-dialog custom-modal modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Ch·ªçn nhi·ªÅu s·∫£n ph·∫©m</h5>
          <button
            type="button"
            class="btn-close"
            @click="$emit('close')"
          ></button>
        </div>
        <div class="modal-body">
          <input
            type="text"
            class="form-control mb-3"
            placeholder="T√¨m ki·∫øm theo t√™n, m√£ SKU, Barcode s·∫£n ph·∫©m"
            v-model="search"
          />

          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>#</th>
                  <th>·∫¢nh</th>
                  <th>M√£</th>
                  <th>S·∫£n ph·∫©m</th>
                  <th>K√≠ch th∆∞·ªõc</th>
                  <th>M√†u s·∫Øc</th>
                  <th>Ch·∫•t li·ªáu</th>
                  <th>Gi√°</th>
                  <th>Kho</th>
                  <th>S·ªë l∆∞·ª£ng mua</th>
                  <th>H√†nh ƒë·ªông</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="(item, index) in listSanPham" :key="index">
                  <td>{{ index }}</td>
                  <td>
                    <img
                      src="https://img.lovepik.com/free-png/20210923/lovepik-t-shirt-png-image_401190055_wh1200.png"
                      style="width: 20px; height: 20px"
                    />
                  </td>
                  <td>{{ item.maChiTietSapPham }}</td>
                  <td>{{ item.idSanPham.tenSanPham }}</td>
                  <td>{{ item.idSize.soCo }}</td>
                  <td>{{ item.idMau.ten }}</td>
                  <td>{{ item.idSanPham.idChatLieu.tenChatLieu }}</td>
                  <td>{{ item.gia }}</td>
                  <td>
                    {{
                      item.soLuong - (quantities[item.maChiTietSapPham] || 0)
                    }}
                  </td>
                  <td >
                    <input
                      type="number"
                      min="1"
                      :max="item.soLuong"
                      v-model.number="quantities[item.maChiTietSapPham]"
                      :disabled="
                        !selectedItems.some(
                          (i) => i.maChiTietSapPham === item.maChiTietSapPham
                        )
                      "
                      class="form-control form-control-sm"
                      style="width: 70px"
                    />
                  </td>
                  <td class="text-center">
                    <input
                      type="checkbox"
                      :checked="
                        selectedItems.some(
                          (i) => i.maChiTietSapPham === item.maChiTietSapPham
                        )
                      "
                      @change="toggleSelection(item)"
                    />
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" @click="$emit('close')">H·ªßy</button>
          <button class="btn btn-primary" @click="apply">√Åp d·ª•ng</button>
        </div>
      </div>
    </div>
  </div>
  <h2>{{ maHoaDon }}</h2>
</template>

<style scoped>
.custom-modal {
  max-width: 80vw;
}
</style>
